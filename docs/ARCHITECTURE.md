# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ChessOnline

## –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Browser   ‚îÇ
‚îÇ  (React +   ‚îÇ
‚îÇ   WS client)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ HTTPS/WSS
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     API Gateway + WS Gateway    ‚îÇ
‚îÇ      (Spring Boot)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚ñ∫ Auth Service (JWT)
       ‚îú‚îÄ‚ñ∫ User Service
       ‚îú‚îÄ‚ñ∫ Matchmaking Service
       ‚îú‚îÄ‚ñ∫ Invite Service
       ‚îú‚îÄ‚ñ∫ Game Service (Chess logic)
       ‚îî‚îÄ‚ñ∫ Rating Service (Elo)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL  ‚îÇ    ‚îÇ   Redis   ‚îÇ
‚îÇ   (main DB)  ‚îÇ    ‚îÇ  (cache)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Frontend (React + TypeScript)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏:**
- **Auth**: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, JWT —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- **Profile**: –ø—Ä–æ—Ñ–∏–ª—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∏—Å—Ç–æ—Ä–∏—è
- **Matchmaking**: –ø–æ–∏—Å–∫ –∏–≥—Ä—ã, –æ—á–µ—Ä–µ–¥—å
- **Invite**: —Å–æ–∑–¥–∞–Ω–∏–µ/–≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ, QR
- **Game**: –¥–æ—Å–∫–∞, —Ö–æ–¥—ã, —á–∞—Ç, —Ç–∞–π–º–µ—Ä
- **Leaderboard**: —Ä–µ–π—Ç–∏–Ω–≥-—Ç–∞–±–ª–∏—Ü—ã

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:**
- `chess.js` ‚Äî –ª–æ–≥–∏–∫–∞ —à–∞—Ö–º–∞—Ç (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
- `react-chessboard` ‚Äî UI –¥–æ—Å–∫–∏
- `zustand` ‚Äî state management
- `@stomp/stompjs` ‚Äî WebSocket client

---

### 2. Backend (Spring Boot)

#### 2.1 Auth Service
- JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è/–≤–∞–ª–∏–¥–∞—Ü–∏—è
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–ª–æ–≥–∏–Ω
- OAuth (Google, GitHub) ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è MVP

#### 2.2 User Service
- CRUD –ø—Ä–æ—Ñ–∏–ª–µ–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (wins/losses/draws)
- –†–µ–π—Ç–∏–Ω–≥ (Elo)

#### 2.3 Invite Service
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ TTL (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 —á–∞—Å)
- Join-–ª–æ–≥–∏–∫–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏)

#### 2.4 Matchmaking Service
- –û—á–µ—Ä–µ–¥—å –∏–≥—Ä–æ–∫–æ–≤ (Redis)
- –ü–æ–¥–±–æ—Ä –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É (¬±200 Elo)
- –¢–∞–π–º–∞—É—Ç—ã (–µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –∑–∞ 2 –º–∏–Ω—É—Ç—ã)

#### 2.5 Game Service
- WebSocket —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (STOMP)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç–∏ —Ö–æ–¥–æ–≤ (Java Chess Engine –∏–ª–∏ Chesslib)
- PGN –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- –¢–∞–π–º–µ—Ä (Spring Scheduler)
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã (–º–∞—Ç/–ø–∞—Ç/–Ω–∏—á—å—è/—Å–¥–∞—á–∞)

#### 2.6 Rating Service
- Elo –ø–µ—Ä–µ—Å—á—ë—Ç –ø–æ—Å–ª–µ –∏–≥—Ä—ã:
  $$R_{new} = R_{old} + K \cdot (S - E)$$
  –≥–¥–µ $K = 32$ (–¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤), $S$ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç (1, 0.5, 0), $E$ ‚Äî –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –ó–∞–ø–∏—Å—å –≤ `rating_history`

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### PostgreSQL

**–¢–∞–±–ª–∏—Ü—ã:**
- `users` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `user_stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `invites` ‚Äî –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
- `games` ‚Äî –ø–∞—Ä—Ç–∏–∏
- `moves` ‚Äî —Ö–æ–¥—ã
- `rating_history` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞
- `matchmaking_queue` ‚Äî –æ—á–µ—Ä–µ–¥—å –ø–æ–∏—Å–∫–∞

**–ò–Ω–¥–µ–∫—Å—ã:**
- `users.rating` (–¥–ª—è –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞)
- `games.player_white_id`, `games.player_black_id` (–∏—Å—Ç–æ—Ä–∏—è)
- `invites.code` (–±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É)
- `moves.game_id` (–¥–ª—è PGN –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)

### Redis

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ö—ç—à —Å–µ—Å—Å–∏–π JWT
- –û—á–µ—Ä–µ–¥—å –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥–∞ (sorted set –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É)
- –¢–∞–π–º–µ—Ä—ã –∏–≥—Ä (expiration keys)

---

## –†–µ–∞–ª—Ç–∞–π–º (WebSocket)

### –ü—Ä–æ—Ç–æ–∫–æ–ª: STOMP over WebSocket

**–ö–∞–Ω–∞–ª—ã:**
- `/topic/game/{gameId}` ‚Äî —Å–æ–±—ã—Ç–∏—è –∏–≥—Ä—ã (–ø—É–±–ª–∏—á–Ω—ã–µ –¥–ª—è –æ–±–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤)
- `/user/queue/notifications` ‚Äî –ª–∏—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥)

**–°–æ–±—ã—Ç–∏—è:**
- `move` ‚Äî —Ö–æ–¥ —Å–¥–µ–ª–∞–Ω
- `timerTick` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ (–∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É)
- `gameOver` ‚Äî –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- `chatMessage` ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
- `drawOffer`, `drawResponse` ‚Äî –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ/–æ—Ç–≤–µ—Ç –Ω–∞ –Ω–∏—á—å—é
- `resign` ‚Äî —Å–¥–∞—á–∞

**Failover:**
- –ü—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (reconnected event)
- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è –∑–∞ 60 —Å–µ–∫—É–Ω–¥ ‚Äî –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ—Ä–∞–∂–µ–Ω–∏–µ

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **JWT —Ç–æ–∫–µ–Ω—ã:**
   - Expiration: 24 —á–∞—Å–∞
   - Refresh —Ç–æ–∫–µ–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è MVP)

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ö–æ–¥–æ–≤:**
   - –¢–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∫–ª–∏–µ–Ω—Ç –Ω–µ –¥–æ–≤–µ—Ä—è–µ–º)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∏–≥—Ä–æ–∫–∞

3. **Rate limiting:**
   - API: 100 req/min –Ω–∞ IP
   - WS: –∑–∞—â–∏—Ç–∞ –æ—Ç flood-—Å–æ–æ–±—â–µ–Ω–∏–π

4. **–ê–Ω—Ç–∏-—á–∏—Ç (–±–∞–∑–æ–≤—ã–π):**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ö–æ–¥
   - –ê–Ω–∞–ª–∏–∑ –∞–Ω–æ–º–∞–ª–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 90%+ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π —Å –¥–≤–∏–∂–∫–æ–º)

---

## –î–µ–ø–ª–æ–π

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
cd infra
docker-compose up -d  # Postgres + Redis

cd backend
./mvnw spring-boot:run

cd frontend
npm install
npm start
```

### –ü—Ä–æ–¥–∞–∫—à–Ω (–ø—Ä–∏–º–µ—Ä)

```
Docker Compose / Kubernetes
‚îú‚îÄ Frontend (Nginx + React build)
‚îú‚îÄ Backend (Spring Boot JAR)
‚îú‚îÄ PostgreSQL (managed –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
‚îî‚îÄ Redis (managed –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
```

---

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–±—É–¥—É—â–µ–µ)

1. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Backend:**
   - Stateless Spring Boot (—Å–µ—Å—Å–∏–∏ –≤ Redis)
   - Load Balancer (Nginx/HAProxy)

2. **WebSocket:**
   - Sticky sessions –∏–ª–∏ Redis Pub/Sub –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π

3. **Database:**
   - Read replicas –¥–ª—è –ª–∏–¥–µ—Ä–±–æ—Ä–¥–æ–≤
   - –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ `games` –∏ `moves` –ø–æ –¥–∞—Ç–µ

4. **–ö—ç—à:**
   - Redis Cluster
   - CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏

---

## –ê–ª–≥–æ—Ä–∏—Ç–º Elo

$$E_A = \frac{1}{1 + 10^{(R_B - R_A)/400}}$$

$$R_{A,new} = R_A + K \cdot (S_A - E_A)$$

–≥–¥–µ:
- $R_A$, $R_B$ ‚Äî —Ä–µ–π—Ç–∏–Ω–≥–∏ –∏–≥—Ä–æ–∫–æ–≤
- $E_A$ ‚Äî –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è A
- $S_A$ ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (1 = –ø–æ–±–µ–¥–∞, 0.5 = –Ω–∏—á—å—è, 0 = –ø–æ—Ä–∞–∂–µ–Ω–∏–µ)
- $K$ ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (32 –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤, 16 –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö)

---

## –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### ‚úÖ –≠—Ç–∞–ø 1: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- Docker Compose
- –°—Ö–µ–º–∞ –ë–î
- –ë–∞–∑–æ–≤—ã–π README

### üîÑ –≠—Ç–∞–ø 2: Auth & Users
- JWT login/register
- –ü—Ä–æ—Ñ–∏–ª—å CRUD
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### üîÑ –≠—Ç–∞–ø 3: Invite Service
- –°–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–æ–≤–µ—Ä–∫–∞/join
- QR –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ

### üîÑ –≠—Ç–∞–ø 4: Game Service + WebSocket
- WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- –•–æ–¥—ã + –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –¢–∞–π–º–µ—Ä
- PGN —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

### üîÑ –≠—Ç–∞–ø 5: Matchmaking
- –û—á–µ—Ä–µ–¥—å –≤ Redis
- –ü–æ–¥–±–æ—Ä –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É

### üîÑ –≠—Ç–∞–ø 6: Rating & History
- Elo –ø–µ—Ä–µ—Å—á—ë—Ç
- –õ–∏–¥–µ—Ä–±–æ—Ä–¥—ã
- –ò—Å—Ç–æ—Ä–∏—è –ø–∞—Ä—Ç–∏–π

### üîú –≠—Ç–∞–ø 7+: –†–∞—Å—à–∏—Ä–µ–Ω–∏—è
- –¢—É—Ä–Ω–∏—Ä—ã
- Stockfish –∞–Ω–∞–ª–∏–∑
- PWA/Mobile
- –ê–Ω—Ç–∏-—á–∏—Ç (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)
